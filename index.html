<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCM YES School - Advanced FAQ Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles & Custom theme colors */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        .text-theme-dark { color: #333333; }
        .text-theme-blue { color: #2c7cbd; }
        .bg-gradient-red { background: linear-gradient(to right, #e51f17, #c01a14); }
        .bg-gradient-blue { background: linear-gradient(to right, #2c7cbd, #225f92); }
        .bg-theme-yellow { background: linear-gradient(to right, #f8cc18, #f8d844); }
        .border-theme-yellow { border-color: #f8cc18; }

        /* Main container styling and entrance animation */
        #chat-app-container {
            width: 100vw;
            height: 100vh;
            max-width: none;
            max-height: none;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            animation: containerFadeIn 0.8s ease-out forwards;
        }

        @keyframes containerFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header Styling */
        header {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            padding: 1rem 1.25rem;
        }

        /* Chat bubble styles */
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 10px;
            word-wrap: break-word;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 0.5s forwards ease-out;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bot-bubble {
            background-color: #e9e9eb;
            color: #333333;
            border-bottom-left-radius: 6px;
            align-self: flex-start;
            position: relative;
            padding-right: 40px;
        }
        .user-bubble {
            background: linear-gradient(to right, #2c7cbd, #225f92);
            color: #ffffff;
            border-bottom-right-radius: 6px;
            align-self: flex-end;
            text-align: right;
        }

        /* Message text content within bubbles */
        .message-text-content {
            flex-grow: 1;
            text-align: left;
        }

        .user-bubble .message-text-content {
            text-align: right;
        }

        /* Time stamp */
        .timestamp {
            font-size: 0.7rem;
            opacity: 0.8;
            align-self: flex-end;
        }
        .bot-bubble .timestamp {
            align-self: flex-start;
        }

        /* Keyframe animation for messages */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Options slider styles */
        #options-container {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            padding: 15px 10px;
            background-color: #f9f9f9;
            border-top: 1px solid #e9e9e9;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        #options-wrapper {
            display: flex;
            overflow-x: hidden;
            padding: 0 5px;
            flex-grow: 1;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .option-button {
            flex: 0 0 auto;
            margin: 0 6px;
            padding: 10px 18px;
            background-color: #ffffff;
            color: #4a4a4a;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            opacity: 0;
            transform: translateY(10px);
            animation: optionFadeIn 0.3s forwards ease-out;
            font-size: 0.9rem;
        }
        .option-button:hover {
            background: linear-gradient(to right, #f8cc18, #f8d844);
            color: #333333;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            border-color: #f8cc18;
        }
        .option-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .option-button:first-child {
            margin-left: 0;
        }
        .option-button:last-child {
            margin-right: 0;
        }

        @keyframes optionFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Scrollbar styling for chat window */
        #chat-window::-webkit-scrollbar {
            width: 8px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: #f0f0f0;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background: #bdbdbd;
            border-radius: 8px;
        }
        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 10px;
            padding: 12px 16px;
            border-radius: 18px;
            background-color: #e9e9eb;
            color: #333333;
            border-bottom-left-radius: 6px;
            max-width: 80px;
            animation: fadeIn 0.3s ease-out;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #999;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Speaker icon styles within bot messages */
        .bot-bubble .speaker-icon {
            position: absolute;
            right: 12px;
            bottom: 10px;
            cursor: pointer;
            color: #888;
            font-size: 0.9em;
            transition: color 0.2s ease-in-out, transform 0.2s ease;
        }
        .bot-bubble .speaker-icon:hover {
            color: #2c7cbd;
            transform: scale(1.1);
        }
        .bot-bubble .speaker-icon:active {
            transform: scale(0.95);
        }

        /* Clear Chat button styling */
        #clear-chat-button {
            background: linear-gradient(to right, #e51f17, #c01a14);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 15px;
            flex-shrink: 0;
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            font-weight: 500;
        }

        #clear-chat-button:hover {
            background: linear-gradient(to right, #c01a14, #a01410);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }
        #clear-chat-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Adjust header to accommodate the button */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header > div:first-child {
            display: flex;
            align-items: center;
        }

        /* Arrow Button Styles */
        .scroll-arrow {
            background: linear-gradient(to right, #f8cc18, #f8d844);
            color: #333333;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            flex-shrink: 0;
            margin: 0 5px;
        }

        .scroll-arrow:hover {
            background: linear-gradient(to right, #f8d844, #f9e26e);
            transform: scale(1.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .scroll-arrow:active {
            transform: scale(0.95);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .scroll-arrow.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            background: #e0e0e0;
            color: #999999;
        }

        /* Style for the logo link to prevent underline and add hover */
        .logo-link {
            text-decoration: none;
            color: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: transform 0.2s ease;
        }

        .logo-link:hover {
            transform: scale(1.01);
        }
        .logo-link:active {
            transform: scale(0.99);
        }

        .logo-link .w-14 {
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .logo-link:hover .w-14 {
            background-color: #f5f5f5;
            transform: rotate(3deg);
        }

        /* Media Queries for Responsiveness - mostly redundant now but keeping for consistency */
        @media (max-width: 600px) {
            body {
                padding: 0;
            }

            #chat-app-container {
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
                max-height: 100vh;
                box-shadow: none;
            }

            header {
                border-radius: 0;
            }

            #options-container {
                border-radius: 0;
                padding: 10px 5px;
            }

            .chat-bubble {
                max-width: 90%;
            }

            .option-button {
                padding: 8px 12px;
                font-size: 0.8rem;
                margin: 0 4px;
            }

            .scroll-arrow {
                width: 32px;
                height: 32px;
                font-size: 0.9em;
            }
            
            #clear-chat-button {
                padding: 6px 10px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body class="bg-white flex items-center justify-center min-h-screen p-0 m-0">
    <div class="w-full h-screen flex flex-col bg-white overflow-hidden chat-container-animate" id="chat-app-container">
        <header class="bg-gradient-red text-white p-4 flex items-center shadow-md z-10">
            <div class="flex items-center">
                <a href="https://dcmyesschool.com" target="_blank" class="logo-link" aria-label="Visit DCM YES School Website">
                    <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                        <img src="logo.png" alt="DCM YES School Logo - Click to visit website" class="w-10 h-10 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/40x40/ffffff/e51f17?text=DCM+Logo';">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">DCM YES School</h1>
                        <p class="text-sm opacity-90">How can I help you today?</p>
                    </div>
                </a>
            </div>
            <button id="clear-chat-button" class="ml-auto" aria-label="Clear Chat History">Clear Chat</button>
        </header>

        <main id="chat-window" class="flex-1 p-4 md:p-6 overflow-y-auto" role="log" aria-live="polite" aria-atomic="false">
            <div id="date-display" class="text-center text-gray-500 text-sm mb-4"></div>
            <div id="message-container" class="flex flex-col space-y-4">
                </div>
        </main>

        <footer id="options-container" class="p-4 border-t border-gray-200 bg-gray-50 overflow-hidden flex items-center justify-content-center">
            <button id="scroll-left-btn" class="scroll-arrow mr-2" aria-label="Scroll options left"><i class="fas fa-chevron-left"></i></button>
            <div id="options-wrapper" class="flex-1 overflow-x-hidden" role="group" aria-label="Available questions">
                </div>
            <button id="scroll-right-btn" class="scroll-arrow ml-2" aria-label="Scroll options right"><i class="fas fa-chevron-right"></i></button>
        </footer>
		    <div style="text-align: center; margin-top: 20px; font-size: 0.8em; color: #777;">
        Created by Riddhish, a 10-year-old student from Grade 6.
    </div>
    </div>

    <script>
        // --- ChatService: Simulates interaction with a backend API ---
        class ChatService {
            constructor() {
                // In a real application, this would be an actual API endpoint.
                // For demonstration, we simulate data and network delay.
                this.qaDatabase = {
                    'start': {
                        question: 'Initial prompt',
                        answer: 'Welcome to <strong>DCM YES School</strong>, a legacy in education since 1946. We are committed to fostering an environment of academic excellence and holistic development. How can we assist you today?'
                    },
                    'admissions': {
                        question: 'Admissions Info',
                        answer: 'Our admission process for the new academic year typically begins in <strong>November</strong>. For detailed information on eligibility, required documents, and key dates, please visit the <a href="https://dcmyesschool.com/contact" class="text-theme-blue font-semibold" target="_blank">admissions section on our official website</a>.',
                        followUpAnswer: 'To confirm, admissions generally start in November. All details on eligibility and forms are on the <a href="https://dcmyesschool.com/contact" class="text-theme-blue font-semibold" target="_blank">official website</a>. Please check there for the most current information.'
                    },
                    'curriculum': {
                        question: 'Our Curriculum',
                        answer: 'We proudly follow the <strong>CBSE curriculum</strong>, enriched with a bespoke curriculum for all age groups including <strong>Mother\'s Lap, CCLICK, SLITEE, and CLASSE</strong> programs. This ensures all-round development with a wide variety of co-curricular and extra-curricular activities.',
                        followUpAnswer: 'Our curriculum is a blend of <strong>CBSE</strong> and unique programs like <strong>Mother\'s Lap, CCLICK, SLITEE, and CLASSE</strong>, designed for comprehensive development. It emphasizes both academics and co-curricular learning.'
                    },
                    'facilities': {
                        question: 'Campus Facilities',
                        answer: 'Our campus boasts world-class, state-of-the-art facilities including: <ul class="list-disc list-inside mt-2"><li>Digitally networked Smart Classrooms</li><li>Ultra Modern Labs (Physics, Chemistry, Biology, Social Studies, Maths, AI/Robotics, Special Language Lab)</li><li>A Hi-tech, well-stocked Library</li><li>Spacious Sports Grounds for indoor & outdoor games (with expert coaches)</li><li>Secure Transportation Services</li><li>Kids Amusement Park with rides & animated characters</li><li>Experiential Learning Studios</li><li>Finishing & Grooming classes for girls (Etiquette Villa)</li><li>Activity Block (Meditation, Music, Art & Craft, Dance room)</li><li>Separate Computer labs for Junior & Senior wings with 24-hour high-speed Internet</li><li>Smart Boards & Conference Room</li><li>STEM (Science, Technology, Engineering and Math) labs</li><li>e-Counseling Cell & Provision for day-boarding</li><li>Special classes for competitive exams (IIT, NEET/JEE, AFMC, AIIMS, NDA, NTSE, KVPY)</li><li>Safe and secure environment with round-the-clock security</li></ul>',
                        followUpAnswer: 'In summary, our campus features modern facilities such as Smart Classrooms, a variety of advanced labs including AI and STEM, extensive sports grounds, a library, and unique offerings like our Etiquette Villa and Kids Amusement Park. We also provide secure transportation.'
                    },
                    'contact': {
                        question: 'Contact Us',
                        answer: 'You can reach us at: <br><br><strong>Landline:</strong> <a href="tel:+911613510099" class="text-theme-blue font-semibold"><strong>+91-161-3510099</strong></a><br><strong>Mobile:</strong> <a href="tel:+918728893030" class="text-theme-blue font-semibold"><strong>+91-8728893030</strong></a><br><strong>General Email:</strong> <a href="mailto:contact@dcmyesschool.com" class="text-theme-blue font-semibold">contact@dcmyesschool.com</a><br><strong>Admissions Email:</strong> <a href="mailto:admissions@dcmyesschool.com" class="text-theme-blue font-semibold">admissions@dcmyesschool.com</a><br><br>We are located at: DCM Young Entrepreneurs School, Block-B, Rajguru Nagar, Ludhiana, Punjab - 141012 (India).',
                        followUpAnswer: 'Our contact numbers are <strong>+91-161-3510099</strong> and <strong>+91-8728893030</strong>. You can email us at <a href="mailto:contact@dcmyesschool.com" class="text-theme-blue font-semibold">contact@dcmyesschool.com</a> or <a href="mailto:admissions@dcmyesschool.com" class="text-theme-blue font-semibold">admissions@dcmyesschool.com</a>. Our school is in Rajguru Nagar, Ludhiana.'
                    },
                    'about_us': {
                        question: 'About The School',
                        answer: 'DCM YES School is a premier institution in Ludhiana with <strong>75+ years of acclaimed experience</strong> since its establishment in 1946 by Late Shri M R Dass. We have proudly graduated over <strong>112,500 students</strong> and currently have <strong>20,000+ enrolled students</strong> and <strong>110+ teachers and staff</strong>. Our vision, "From Cradle to Corporate," is dedicated to nurturing young minds and preparing them for the future with a blend of traditional values and modern educational practices, focusing on innovation, entrepreneurship, and emerging technologies like AI, AR, VR, and ML.',
                        followUpAnswer: 'Founded in 1946 by Late Shri M R Dass, DCM YES School has over <strong>75 years of educational excellence</strong>. We focus on innovation and entrepreneurship, preparing students for the future with a blend of traditional and modern learning, including emerging technologies. We\'re proud of our large alumni and student community.'
                    },
                    'achievements': {
                        question: 'Our Achievements',
                        answer: 'DCM YES School stands out with unique programs and innovative environments: <ul class="list-disc list-inside mt-2"><li><strong>Dual Diplomas:</strong> Partnership with Houghton Academy, New York, USA, offering an American High School diploma alongside CBSE studies.</li><li><strong>Earn While You Learn:</strong> Internship program fostering leadership and real-world work experience.</li><li><strong>Etiquette Villa:</strong> Dedicated program for personality development, public speaking, and interview skills.</li><li><strong>Advanced Labs:</strong> State-of-the-art AI Lab, Makerspace, IT & Research Center, and AR/VR Lab for cutting-edge learning.</li></ul>We consistently receive accolades for academic excellence, sports, and co-curricular activities, preparing students to excel.',
                        followUpAnswer: 'Our notable achievements include the <strong>Dual Diploma program</strong> with a US academy, the <strong>Earn While You Learn</strong> internships, specialized <strong>Etiquette Villa</strong> for personality grooming, and advanced facilities like our <strong>AI, Makerspace, and AR/VR Labs</strong>. We strive for excellence in academics, sports, and co-curricular activities.'
                    },
                    'website': {
                        question: 'Go to Website',
                        answer: 'Opening DCM YES School website in a new tab...',
                        url: 'https://dcmyesschool.com'
                    },
                    'safety_security': {
                        question: 'Safety & Security',
                        answer: 'DCM YES School prioritizes a safe and secure environment with round-the-clock security and robust safety protocols. The campus is meticulously designed to ensure the well-being of all students.',
                        followUpAnswer: 'Our commitment to safety includes 24/7 security and comprehensive protocols to maintain a secure campus for all students.'
                    },
                    'health_wellness': {
                        question: 'Health & Wellness',
                        answer: 'The school features a Health & Wellness Centre and provides Pastoral Care & Counseling Cell services to support the overall well-being and mental health of students.',
                        followUpAnswer: 'We have a dedicated Health & Wellness Centre and a Pastoral Care & Counseling Cell to ensure the holistic well-being of our students.'
                    },
                    'yespreneurship': {
                        question: 'Yespreneurship Programs',
                        answer: 'Our Yespreneurship program fosters entrepreneurial skills through Incubation Cells, Industry Interface, a Finishing School, Financial Literacy, Legal Literacy, Soft Skills development, and Student Leadership initiatives. We also offer International Exposure.',
                        followUpAnswer: 'Yespreneurship at DCM YES includes Incubation Cells, industry partnerships, a Finishing School, and various literacy programs focused on financial, legal, and soft skills to develop future leaders with international exposure.'
                    },
                    'innovation': {
                        question: 'Innovation at YES',
                        answer: 'Innovation is central to our learning, with facilities like Robotics Lab, AI Lab, Makerspace, IT & Research Center, VR Lab, Junior Student Research Fellowship, Design Thinking, Coding, Patent Support, and programs like Protons, Wheelocity, and Kiddovators.',
                        followUpAnswer: 'Our innovation focus is supported by state-of-the-art labs for Robotics, AI, VR, and IT, alongside programs encouraging Design Thinking, Coding, and student research projects like Kiddovators.'
                    },
                    'sports': {
                        question: 'Sports Facilities',
                        answer: 'We offer world-class sports facilities including a Shooting Range, Ace Badminton Academy, Aqua Star Swimming Club, and various indoor (Chess, Table Tennis, Billiards) and outdoor (Golf, Archery, Mini Soccer, Cricket, Basketball) sports, along with Elementary Sports for younger students.',
                        followUpAnswer: 'DCM YES provides extensive sports facilities: a Shooting Range, Badminton, Swimming, and a wide array of indoor and outdoor games like Golf, Cricket, and Basketball, supported by expert coaches.'
                    },
                    'global_programs': {
                        question: 'Global Programs & Exposure',
                        answer: 'Our global initiatives include a Foreign Languages Centre, Student Exchange Programs, International Excursions, an American High School Diploma option, Overseas Education Plan, Study Abroad Clinic, and an IELTS Centre, preparing students for international opportunities.',
                        followUpAnswer: 'For global exposure, we offer Foreign Languages, Student Exchange Programs, International Excursions, the American High School Diploma, and support for overseas education and IELTS preparation.'
                    }
                };

                this.questionAskCount = {}; // Tracks how many times each question has been asked
            }

            /**
             * Simulates an API call to get the initial welcome message and options.
             * In a real scenario, this might hit a /start endpoint.
             * @returns {Promise<Object>} A promise resolving with the start data.
             */
            async getStartData() {
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve({
                            message: this.qaDatabase['start'].answer,
                            options: this.getAllPrimaryOptionKeys()
                        });
                    }, 500); // Simulate network latency
                });
            }

            /**
             * Simulates an API call to get a response for a specific question.
             * In a real scenario, this might hit a /ask endpoint with the question key.
             * @param {string} questionKey - The key of the question asked.
             * @returns {Promise<Object>} A promise resolving with the answer and potential follow-up actions.
             */
            async getAnswer(questionKey) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const data = this.qaDatabase[questionKey];
                        if (data) {
                            this.questionAskCount[questionKey] = (this.questionAskCount[questionKey] || 0) + 1;
                            const answer = (this.questionAskCount[questionKey] > 1 && data.followUpAnswer) ?
                                data.followUpAnswer : data.answer;
                            
                            resolve({
                                question: data.question,
                                answer: answer,
                                url: data.url || null, // For 'website' option
                                options: this.getAllPrimaryOptionKeys() // Always return primary options for now
                            });
                        } else {
                            reject(new Error('Question not found'));
                        }
                    }, 1000); // Simulate processing time + network latency
                });
            }

            /**
             * Retrieves all primary option keys.
             * @returns {string[]} An array of question keys.
             */
            getAllPrimaryOptionKeys() {
                return [
                    'admissions', 'curriculum', 'facilities', 'contact', 'about_us', 'achievements',
                    'safety_security', 'health_wellness', 'yespreneurship', 'innovation', 'sports',
                    'global_programs', 'website'
                ];
            }

            /**
             * Resets the internal state (e.g., question ask counts).
             * In a real system, this might involve clearing session data on the backend.
             */
            resetState() {
                this.questionAskCount = {};
            }
        }

        // --- ChatUI: Manages DOM manipulation and user interaction ---
        class ChatUI {
            constructor(chatService) {
                this.chatService = chatService;

                this.messageContainer = document.getElementById('message-container');
                this.chatWindow = document.getElementById('chat-window');
                this.optionsWrapper = document.getElementById('options-wrapper');
                this.dateDisplay = document.getElementById('date-display');
                this.clearChatButton = document.getElementById('clear-chat-button');
                this.scrollLeftBtn = document.getElementById('scroll-left-btn');
                this.scrollRightBtn = document.getElementById('scroll-right-btn');

                this.currentUtterance = null;
                this.currentSpeakerIcon = null;
                this.selectedVoice = null;

                this.initializeSpeechSynthesis();
                this.addEventListeners();
            }

            initializeSpeechSynthesis() {
                if ('speechSynthesis' in window) {
                    speechSynthesis.onvoiceschanged = () => {
                        this.selectedVoice = this.getHumanLikeVoice();
                        if (!this.selectedVoice) {
                            console.warn("No suitable speech synthesis voice found. Using default or no voice if none available.");
                        } else {
                            console.log("Selected voice for speech synthesis:", this.selectedVoice.name);
                        }
                    };
                    if (speechSynthesis.getVoices().length > 0) {
                        this.selectedVoice = this.getHumanLikeVoice();
                    }
                } else {
                    console.warn("Web Speech API not supported in this browser.");
                }
            }

            getHumanLikeVoice() {
                const voices = speechSynthesis.getVoices();
                let chosenVoice = null;
                chosenVoice = voices.find(voice => voice.lang === 'en-US' && voice.name.includes('Google US English'));
                if (chosenVoice) return chosenVoice;
                chosenVoice = voices.find(voice => voice.lang.startsWith('en-') && (voice.name.includes('Google') || voice.name.includes('Microsoft')));
                if (chosenVoice) return chosenVoice;
                chosenVoice = voices.find(voice => voice.lang.startsWith('en-'));
                if (chosenVoice) return chosenVoice;
                return voices[0] || null;
            }

            stopSpeaking(iconElement, originalTextContent) {
                if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
                if (iconElement && iconElement === this.currentSpeakerIcon) {
                    iconElement.className = 'fas fa-volume-up speaker-icon';
                    iconElement.onclick = () => this.speakText(originalTextContent, iconElement);
                }
                this.currentUtterance = null;
                this.currentSpeakerIcon = null;
            }

            speakText(text, iconElement) {
                if (!('speechSynthesis' in window)) {
                    console.warn("Web Speech API not supported.");
                    return;
                }

                if (window.speechSynthesis.speaking) {
                    const previouslySpeakingIconText = this.currentSpeakerIcon ? (this.currentSpeakerIcon.closest('.chat-bubble')?.querySelector('.message-text-content')?.textContent || '') : '';
                    this.stopSpeaking(this.currentSpeakerIcon, previouslySpeakingIconText);
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                if (this.selectedVoice) {
                    utterance.voice = this.selectedVoice;
                }

                this.currentUtterance = utterance;
                this.currentSpeakerIcon = iconElement;

                if (iconElement) {
                    iconElement.className = 'fas fa-volume-mute speaker-icon';
                    iconElement.onclick = () => this.stopSpeaking(iconElement, text);
                }

                utterance.onend = () => this.stopSpeaking(iconElement, text);
                utterance.oncancel = () => this.stopSpeaking(iconElement, text);
                utterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event.error);
                    this.stopSpeaking(iconElement, text);
                };

                window.speechSynthesis.speak(utterance);
            }

            addEventListeners() {
                this.clearChatButton.addEventListener('click', this.clearChat.bind(this));
                this.scrollLeftBtn.addEventListener('click', () => this.scrollOptions('left'));
                this.scrollRightBtn.addEventListener('click', () => this.scrollOptions('right'));
                this.optionsWrapper.addEventListener('scroll', this.updateArrowVisibility.bind(this));
                window.addEventListener('resize', this.updateArrowVisibility.bind(this));
            }

            saveChat() {
                localStorage.setItem('chatMessages', this.messageContainer.innerHTML);
            }

            loadChat() {
                const savedChat = localStorage.getItem('chatMessages');
                if (savedChat) {
                    if (savedChat.trim().length < 50) {
                        console.warn("Detected potentially malformed or too short chat history in localStorage. Clearing it.");
                        localStorage.removeItem('chatMessages');
                        this.messageContainer.innerHTML = '';
                        return false;
                    }
                    this.messageContainer.innerHTML = savedChat;
                    this.messageContainer.querySelectorAll('.bot-bubble .speaker-icon').forEach(icon => {
                        const textContentElement = icon.closest('.chat-bubble').querySelector('.message-text-content');
                        const plainText = textContentElement ? (textContentElement.textContent || textContentElement.innerText || '').trim() : '';
                        icon.onclick = () => this.speakText(plainText, icon);
                        icon.setAttribute('aria-label', 'Read message aloud');
                    });
                    this.scrollToBottom();
                    return true;
                }
                return false;
            }

            getCurrentTime() {
                const now = new Date();
                return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            displayCurrentDate() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                this.dateDisplay.textContent = now.toLocaleDateString('en-US', options);
            }

            scrollToBottom() {
                this.chatWindow.scrollTo({
                    top: this.chatWindow.scrollHeight,
                    behavior: 'smooth'
                });
            }

            addMessage(text, sender, delay = 0) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-bubble ${sender === 'bot' ? 'bot-bubble' : 'user-bubble'}`;
                        messageDiv.setAttribute('role', 'status');

                        const textContentSpan = document.createElement('span');
                        textContentSpan.innerHTML = text;
                        textContentSpan.classList.add('message-text-content');

                        const timeSpan = document.createElement('span');
                        timeSpan.className = 'timestamp';
                        timeSpan.textContent = this.getCurrentTime();

                        if (sender === 'bot') {
                            const contentWrapper = document.createElement('div');
                            contentWrapper.style.display = 'flex';
                            contentWrapper.style.flexDirection = 'column';
                            contentWrapper.style.flexGrow = '1';

                            contentWrapper.appendChild(textContentSpan);
                            contentWrapper.appendChild(timeSpan);

                            messageDiv.appendChild(contentWrapper);

                            const plainText = textContentSpan.textContent || textContentSpan.innerText || '';
                            const speakerIcon = document.createElement('i');
                            speakerIcon.className = 'fas fa-volume-up speaker-icon';
                            speakerIcon.title = 'Read aloud';
                            speakerIcon.setAttribute('aria-label', 'Read message aloud');
                            speakerIcon.onclick = () => this.speakText(plainText, speakerIcon);
                            messageDiv.appendChild(speakerIcon);

                        } else {
                            messageDiv.appendChild(textContentSpan);
                            messageDiv.appendChild(timeSpan);
                        }

                        this.messageContainer.appendChild(messageDiv);
                        this.scrollToBottom();
                        this.saveChat();
                        resolve(messageDiv); // Resolve when message is added
                    }, delay);
                });
            }

            showTypingIndicator() {
                const indicatorDiv = document.createElement('div');
                indicatorDiv.className = 'typing-indicator bot-bubble';
                indicatorDiv.innerHTML = '<span></span><span></span><span></span>';
                indicatorDiv.setAttribute('aria-live', 'off');
                this.messageContainer.appendChild(indicatorDiv);
                this.scrollToBottom();
                return indicatorDiv;
            }

            hideTypingIndicator(indicatorDiv) {
                if (indicatorDiv && this.messageContainer.contains(indicatorDiv)) {
                    this.messageContainer.removeChild(indicatorDiv);
                }
            }

            showOptions(optionKeys) {
                this.optionsWrapper.innerHTML = '';
                this.optionsWrapper.setAttribute('aria-hidden', 'false');

                if (!optionKeys || optionKeys.length === 0) {
                    this.updateArrowVisibility();
                    this.optionsWrapper.setAttribute('aria-hidden', 'true');
                    return;
                }

                optionKeys.forEach((key, index) => {
                    // We need the question text from the service's qaDatabase
                    const questionData = this.chatService.qaDatabase[key];
                    if (!questionData || !questionData.question) {
                        console.warn(`Question for key "${key}" not found in qaDatabase.`);
                        return;
                    }

                    const button = document.createElement('button');
                    button.textContent = questionData.question;
                    button.className = 'option-button';
                    button.dataset.key = key;
                    button.setAttribute('role', 'button');
                    button.setAttribute('aria-label', `Ask about ${questionData.question}`);

                    button.style.animationDelay = `${index * 0.05}s`;

                    button.addEventListener('click', this.handleOptionClick.bind(this));
                    this.optionsWrapper.appendChild(button);
                });
                this.updateArrowVisibility();
            }

            async handleOptionClick(event) {
                const key = event.currentTarget.dataset.key;

                this.stopSpeaking(this.currentSpeakerIcon, '');

                const questionText = this.chatService.qaDatabase[key]?.question;
                if (questionText) {
                    await this.addMessage(questionText, 'user');
                } else {
                    console.error(`Question text not found for key: ${key}`);
                    return;
                }
                
                this.optionsWrapper.innerHTML = '';
                this.optionsWrapper.setAttribute('aria-hidden', 'true');
                this.updateArrowVisibility();

                if (key === 'website' && this.chatService.qaDatabase[key].url) {
                    await this.addMessage(this.chatService.qaDatabase[key].answer, 'bot');
                    setTimeout(() => {
                        window.open(this.chatService.qaDatabase[key].url, '_blank');
                        this.showOptions(this.chatService.getAllPrimaryOptionKeys());
                    }, 500);
                } else {
                    const typingIndicator = this.showTypingIndicator();
                    try {
                        const response = await this.chatService.getAnswer(key);
                        this.hideTypingIndicator(typingIndicator);
                        await this.addMessage(response.answer, 'bot');
                        setTimeout(() => {
                            this.showOptions(response.options);
                        }, 300);
                    } catch (error) {
                        console.error("Error fetching answer:", error);
                        this.hideTypingIndicator(typingIndicator);
                        await this.addMessage("I'm sorry, I couldn't retrieve that information at the moment. Please try again later.", 'bot');
                        setTimeout(() => {
                            this.showOptions(this.chatService.getAllPrimaryOptionKeys());
                        }, 300);
                    }
                }
            }

            async clearChat() {
                this.stopSpeaking(this.currentSpeakerIcon, '');
                localStorage.removeItem('chatMessages');
                this.messageContainer.innerHTML = '';
                this.chatService.resetState(); // Reset state in the service
                await this.startChat();
            }

            scrollOptions(direction) {
                const scrollAmount = this.optionsWrapper.clientWidth * 0.7;
                if (direction === 'left') {
                    this.optionsWrapper.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
                } else {
                    this.optionsWrapper.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                }
            }

            updateArrowVisibility() {
                setTimeout(() => {
                    const { scrollLeft, scrollWidth, clientWidth } = this.optionsWrapper;

                    if (scrollWidth <= clientWidth) {
                        this.scrollLeftBtn.classList.add('hidden', 'disabled');
                        this.scrollRightBtn.classList.add('hidden', 'disabled');
                        return;
                    } else {
                        this.scrollLeftBtn.classList.remove('hidden');
                        this.scrollRightBtn.classList.remove('hidden');
                    }

                    if (scrollLeft <= 2) {
                        this.scrollLeftBtn.classList.add('disabled');
                    } else {
                        this.scrollLeftBtn.classList.remove('disabled');
                    }

                    if (scrollLeft + clientWidth >= scrollWidth - 2) {
                        this.scrollRightBtn.classList.add('disabled');
                    } else {
                        this.scrollRightBtn.classList.remove('disabled');
                    }
                }, 100);
            }

            async startChat() {
                this.displayCurrentDate();
                const chatLoaded = this.loadChat();

                if (!chatLoaded || this.messageContainer.children.length === 0) {
                    const typingIndicator = this.showTypingIndicator();
                    try {
                        const startData = await this.chatService.getStartData();
                        this.hideTypingIndicator(typingIndicator);
                        await this.addMessage(startData.message, 'bot');
                        setTimeout(() => {
                            this.showOptions(startData.options);
                        }, 300);
                    } catch (error) {
                        console.error("Error fetching start data:", error);
                        this.hideTypingIndicator(typingIndicator);
                        await this.addMessage("Welcome! I'm currently experiencing some issues. Please try again later.", 'bot');
                    }
                } else {
                    this.showOptions(this.chatService.getAllPrimaryOptionKeys());
                }
                this.updateArrowVisibility();
            }
        }

        // --- Application Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const chatService = new ChatService();
            const chatUI = new ChatUI(chatService);
            chatUI.startChat();
        });
    </script>
</body>
</html>